- [Race Conditions(条件竞争)](#race-conditions条件竞争)
  - [重复使用优惠券](#重复使用优惠券)
  - [绕过速率限制](#绕过速率限制)
  - [参考](#参考)

# Race Conditions(条件竞争)
条件竞争一般是由于极短时间内并发请求导致的逻辑问题，在极短时间内对同一个数据进行了重复操作，可能导致该数据被重复使用，或者绕过一些服务器对该数据的访问限制。  
![](img/16-20-22.png)  

BurpSuite支持发送Single Pack请求(HTTP2)，即将多个http请求(20~30个)放在一个tcp包中进行发送，来避免多个http请求之间的在到达服务器之前网络波动造成的时间差，使得漏洞利用成功率更高。  
![](img/18-05-44.png)  
## 重复使用优惠券
一般一张优惠券只能使用一次，当使用了之后需要将优惠券从数据库中删除或者将可用状态置为false,但这个后续的处理过程中存在一个很短的处理时间差(通常只有几毫秒，甚至可能更短)，如果在这个时间差内该优惠券再次被用户提交，由于该优惠券还未完成删除操作，及优惠券仍处于可用状态，这导致优惠券被重复使用。  
![](img/17-01-45.png)
输入一个优惠券可以获得20%折扣，当使用了之后再次输入则会提示已经被使用了，将多个相同使用该优惠券的请求在burp中放到一个group中，使用Single Pack发送，将所有请求使用一个tcp包发送（利用不稳定，需要多次尝试）。  
![](img/17-03-50.png)  
最后该优惠券被重复使用。  
![](img/17-22-35.png)
## 绕过速率限制
一般登录时会有防止爆破的保护措施，如对一个账户进行短时间内多次密码尝试失败则会导致账户锁定。  

常见的实现逻辑为当账户登录失败三次后则将该账户的状态置为锁定或者将该账户加入黑名单（可能是数据库的一个表或者是账户的一个字段属性）中，那么在判断该账户是否登录失败三次并修改相关数据库数据的过程中也存在一个极短的时间差，在修改完成之前我们还是可以发送大量登录请求进行爆破来绕过登录失败三次则锁定账户的限制。
使用Turbo Intruder可以实现使用Single Pack请求来爆破密码，其中的每个请求的密码字段都不同，实现一个tcp包中包含多个不同密码的登录请求。  
一分钟输入三次错误密码则被限制登录。  
![](img/17-58-55.png)  
使用race-single-packet模板
![](img/18-00-14.png)   
成功发送大量请求爆破成功。  
![](img/18-02-56.png)  


## 参考
https://portswigger.net/web-security/race-conditions  
https://portswigger.net/research/smashing-the-state-machine  